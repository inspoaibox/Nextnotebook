# Implementation Plan: 暮城笔记

## Overview

本实现计划将暮城笔记从设计转化为可工作的 Electron + React + TypeScript 应用。采用增量开发方式，优先实现核心功能，然后逐步添加高级特性。计划包含25个主要任务和70+个子任务，每个任务都建立在前一个任务的基础上，确保系统始终处于可工作状态。

## Tasks

- [x] 1. 项目初始化和基础架构
  - 创建 Electron + React + TypeScript 项目结构
  - 配置开发环境和构建工具
  - 集成 Ant Design UI 组件库
  - 设置基础的应用窗口和菜单
  - _Requirements: 31.1, 31.5_

- [x]* 1.1 配置开发工具和代码质量
  - 配置 ESLint、Prettier 和 TypeScript 严格模式
  - 设置 Jest 测试框架和 fast-check 属性测试库
  - 配置 GitHub Actions 或类似的 CI/CD 流程
  - _Requirements: 31.8_

- [x] 2. 数据库层实现
  - [x] 2.1 SQLite 数据库集成
    - 集成 better-sqlite3 库
    - 实现数据库初始化和 schema 创建
    - 创建统一的 Item 表结构和索引
    - _Requirements: 3.1, 3.2_

  - [ ]* 2.2 数据库层属性测试
    - **Property 6: 统一数据模型存储**
    - **Validates: Requirements 3.2**

  - [x] 2.3 实现 ItemsManager 核心类
    - 实现 CRUD 操作 (create, read, update, delete)
    - 实现软删除机制
    - 添加内容哈希计算和版本控制
    - 实现数据库schema版本控制和自动升级
    - _Requirements: 1.1, 1.3, 3.4, 13.5_

  - [ ]* 2.4 ItemsManager 属性测试
    - **Property 1: 笔记创建唯一性和持久化**
    - **Property 3: 软删除数据完整性**
    - **Validates: Requirements 1.1, 1.3**

- [x] 3. 基础 UI 框架
  - [x] 3.1 主界面布局
    - 实现三栏布局 (侧边栏、笔记列表、编辑器)
    - 集成 Ant Design Layout 组件
    - 实现响应式设计和面板大小调整
    - _Requirements: 11.1_

  - [x] 3.2 笔记列表组件
    - 实现笔记列表显示
    - 添加基础搜索框功能
    - 实现置顶笔记优先显示
    - _Requirements: 1.5_

  - [ ]* 3.3 笔记列表属性测试
    - **Property 5: 置顶笔记排序优先级**
    - **Validates: Requirements 1.5**

- [x] 4. Markdown 编辑器集成
  - [x] 4.1 Monaco Editor 集成
    - 集成 @monaco-editor/react
    - 配置 Markdown 语法高亮
    - 实现自动保存功能
    - _Requirements: 1.2, 31.2_

  - [x] 4.2 Markdown 渲染器
    - 集成 marked.js 和 react-markdown
    - 实现实时预览功能
    - 配置代码语法高亮 (highlight.js)
    - _Requirements: 1.2, 31.3_

  - [ ]* 4.3 Markdown 处理属性测试
    - **Property 2: Markdown处理一致性**
    - **Validates: Requirements 1.2**

- [x] 5. 附件和资源管理
  - [x] 5.1 图片和文件处理
    - 实现拖拽和粘贴图片功能
    - 实现附件存储和引用管理
    - 添加图片预览和附件下载
    - _Requirements: 4.1, 4.2, 4.3_

  - [x] 5.2 附件在编辑器中的集成
    - 实现附件在 Markdown 中的引用语法
    - 实现附件完整性验证
    - 添加附件管理界面
    - _Requirements: 4.4, 4.5_

- [x] 6. 文件夹和标签系统
- [x] 6. 文件夹和标签系统
  - [x] 6.1 文件夹管理
    - 实现文件夹 CRUD 操作
    - 实现嵌套文件夹结构
    - 添加文件夹树形显示组件
    - _Requirements: 2.1, 2.2, 2.5_

  - [x] 6.2 标签系统
    - 实现标签 CRUD 操作
    - 实现多标签关联和筛选
    - 添加标签输入和显示组件
    - _Requirements: 2.3, 2.4_

  - [ ]* 6.3 文件夹和标签属性测试
    - **Property 7: 条件查询准确性**
    - **Validates: Requirements 3.3**

- [x] 7. 全文搜索功能
  - [x] 7.1 FTS5 全文搜索集成
    - 配置 SQLite FTS5 虚拟表
    - 实现搜索索引的自动更新
    - 实现搜索结果高亮显示
    - _Requirements: 1.4, 24.1_

  - [ ]* 7.2 搜索功能属性测试
    - **Property 4: 搜索结果相关性**
    - **Validates: Requirements 1.4**

  - [x] 7.3 高级搜索功能
    - 实现按标签、文件夹、日期筛选
    - 添加搜索历史和保存搜索
    - 实现搜索结果排序和分页
    - 实现图片OCR文本和PDF内容搜索
    - _Requirements: 24.2, 24.4, 24.5_

- [x] 8. 检查点 - 核心功能验证
  - 确保所有基础功能正常工作
  - 运行所有单元测试和属性测试
  - 验证用户可以创建、编辑、搜索笔记
  - 询问用户是否有问题需要解决

- [x] 9. 加密引擎实现
  - [x] 8.1 CryptoEngine 核心类
    - 实现 AES-256-GCM 加密/解密
    - 实现 PBKDF2 密钥派生
    - 实现统一的加密数据格式
    - _Requirements: 8.1, 27.1, 27.2_

  - [ ]* 8.2 加密引擎属性测试
    - **Property 12: 加密标准合规性**
    - **Validates: Requirements 8.1, 27.1, 27.2**

  - [x] 8.3 同步密钥管理
    - 实现同步密钥生成和存储
    - 集成 keytar 系统密钥库
    - 实现密钥导出/导入功能 (二维码支持)
    - _Requirements: 28.1, 28.2, 28.6_

  - [x] 8.4 混合加密/明文处理
    - 实现根据 encryption_applied 字段处理数据
    - 添加加密模式切换功能
    - 实现批量数据加密状态转换
    - _Requirements: 8.4, 8.6, 8.7_

  - [ ] 9.4 笔记独立密码保护
    - 实现笔记级别的独立密码设置
    - 实现密码验证和访问控制
    - 添加密码保护笔记的UI标识
    - _Requirements: 9.1, 9.2, 9.3, 9.4_

  - [ ]* 9.5 混合数据处理属性测试
    - **Property 14: 混合数据处理一致性**
    - **Property 13: 明文同步透明性**
    - **Validates: Requirements 8.7, 8.2**

- [x] 10. WebDAV 同步实现
  - [x] 9.1 WebDAV 适配器
    - 集成 webdav 客户端库
    - 实现 StorageAdapter 接口
    - 实现文件上传/下载和目录操作
    - _Requirements: 5.1, 5.3, 5.4_

  - [ ]* 9.2 WebDAV 配置属性测试
    - **Property 8: WebDAV配置验证**
    - **Validates: Requirements 5.1**

  - [x] 9.3 同步引擎核心
    - 实现三阶段同步 (Push-Pull-Commit)
    - 实现增量同步和变更检测
    - 实现同步游标和状态管理
    - _Requirements: 5.2, 6.1, 6.5_

  - [ ]* 9.4 同步引擎属性测试
    - **Property 9: 三阶段同步执行顺序**
    - **Property 10: 本地变更检测准确性**
    - **Validates: Requirements 5.2, 6.1**

- [x] 11. 自建服务器同步支持
  - [x] 11.1 Server Adapter 实现
    - 实现 RESTful API 客户端
    - 实现与 WebDAV 相同的 StorageAdapter 接口
    - 添加 API 密钥和 JWT 认证支持
    - _Requirements: 15.1, 15.2, 15.3_

  - [x] 11.2 服务器同步优化
    - 实现比 WebDAV 更高效的增量同步
    - 添加服务器健康检查和自动降级
    - 实现同步后端无缝切换
    - _Requirements: 15.4, 15.5, 15.6_

- [x] 12. 定时和自动同步
  - [x] 12.1 同步调度系统
    - 实现应用启动时自动同步
    - 实现定时同步和手动触发
    - 实现内容变更后延迟同步
    - _Requirements: 12.1, 12.2, 12.3, 12.4_

  - [x] 12.2 网络适应性和配置管理
    - 实现网络状态检测和适应
    - 实现网络不可用时的暂停和恢复
    - 添加代理设置和网络配置选项
    - 实现网络限制和流量控制
    - _Requirements: 12.5, 17.1, 17.2, 17.7_

- [x] 13. 冲突处理机制
- [x] 13. 冲突处理机制
  - [x] 13.1 冲突检测和处理
    - 实现同步冲突识别逻辑
    - 实现冲突副本创建机制
    - 添加冲突解决 UI 界面
    - _Requirements: 7.1, 7.2, 7.4, 7.5_

  - [ ]* 13.2 冲突处理属性测试
    - **Property 11: 同步冲突处理完整性**
    - **Validates: Requirements 7.1, 7.2**

  - [x] 13.3 同步密钥安全机制
    - 实现密钥兼容性检查
    - 实现同步拒绝和锁定机制
    - 添加密钥冲突处理 UI
    - _Requirements: 28.4, 28.5, 28.10_

  - [ ]* 13.4 同步安全属性测试
    - **Property 15: 同步密钥安全拒绝**
    - **Validates: Requirements 28.5**

- [x] 14. 检查点 - 同步功能验证
  - 确保同步功能完整工作
  - 测试加密和明文同步模式
  - 验证冲突处理和密钥安全
  - 询问用户是否有问题需要解决

- [x] 15. 附件同步和大文件处理
  - [x] 15.1 附件同步机制
    - 实现附件元数据和二进制分离同步
    - 实现大文件分块上传/下载
    - 添加附件完整性验证和断点续传
    - _Requirements: 4.5, 18.1_

  - [x] 15.2 大文件优化
    - 实现文件压缩和去重
    - 添加上传/下载进度显示
    - 实现附件缓存和清理策略
    - _Requirements: 18.1, 18.3_

- [x] 16. 应用设置和主题系统
- [x] 16. 应用设置和主题系统
  - [x] 16.1 设置管理系统
    - 实现应用设置存储和同步
    - 实现设置的平台特定处理
    - 添加设置导入/导出功能
    - _Requirements: 20.1, 20.4, 20.5_

  - [x] 16.2 主题和界面定制
    - 实现浅色/深色主题切换
    - 实现跟随系统主题功能
    - 添加字体大小和界面定制选项
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 17. 笔记模板系统
  - [x] 17.1 模板管理
    - 实现笔记模板创建和编辑
    - 实现模板变量和替换功能
    - 添加系统默认模板 (日记、会议记录等)
    - _Requirements: 25.1, 25.2, 25.3_

  - [x] 17.2 快速创建功能
    - 实现全局快捷键和快速输入框
    - 实现模板选择和应用
    - 实现模板跨设备同步
    - _Requirements: 25.4, 25.5_

- [x] 18. 数据备份和恢复
- [x] 18. 数据备份和恢复
  - [x] 18.1 备份系统
    - 实现完整数据备份功能
    - 实现增量备份和自动备份
    - 添加备份加密和验证
    - _Requirements: 16.1, 16.2, 16.3, 16.6_

  - [ ]* 18.2 备份恢复属性测试
    - **Property 16: 备份完整性往返**
    - **Validates: Requirements 16.1, 16.4**

  - [x] 18.3 数据恢复功能
    - 实现从备份文件恢复数据
    - 实现跨设备数据迁移
    - 添加恢复进度显示和验证
    - _Requirements: 16.4, 16.7_

- [x] 19. 高级笔记功能
  - [x] 19.1 笔记链接系统
    - 实现 [[笔记标题]] 语法解析
    - 实现笔记间跳转和反向链接
    - 实现链接自动更新机制
    - _Requirements: 22.1, 22.2, 22.4_

  - [ ]* 19.2 笔记链接属性测试
    - **Property 17: 笔记链接语法解析**
    - **Property 18: 链接引用更新一致性**
    - **Validates: Requirements 22.1, 22.4**

  - [x] 19.3 版本历史和回收站
    - 实现笔记版本自动保存
    - 实现版本历史查看和恢复
    - 实现回收站和笔记恢复功能
    - _Requirements: 23.1, 23.2, 23.3, 23.4, 23.5_

  - [ ]* 19.4 版本控制属性测试
    - **Property 19: 版本控制往返一致性**
    - **Validates: Requirements 23.1, 23.3**

- [x] 20. 导出功能
  - [x] 20. 导出功能
  - [x] 20.1 Markdown 和 PDF 导出
    - 实现单个笔记 Markdown 导出
    - 实现 PDF 导出 (保持格式和图片)
    - 实现批量导出功能
    - _Requirements: 10.1, 10.2, 10.3_

  - [x] 20.2 附件导出处理
    - 实现导出时包含附件文件
    - 实现导出路径和文件名处理
    - 添加导出进度显示和结果提示
    - _Requirements: 10.4, 10.5_

- [x] 21. 性能优化和错误处理
  - [x] 21.1 性能优化和数据统计
    - 实现虚拟滚动优化大列表
    - 实现搜索索引和缓存优化
    - 添加启动速度和内存使用优化
    - 实现数据统计和存储使用情况报告
    - _Requirements: 18.4, 18.5, 18.6, 18.7_

  - [x] 21.2 错误处理和审计系统
    - 实现全局错误捕获和处理
    - 实现自动恢复和用户引导恢复
    - 添加日志记录和错误报告
    - 实现关键操作审计日志记录
    - _Requirements: 30.1, 30.2, 30.5, 30.6, 21.6_

- [x] 22. 应用安全和隐私
  - [x] 22.1 应用锁定功能
    - 实现 PIN 码和密码解锁
    - 实现自动锁定和会话管理
    - 添加生物识别支持 (如果可用)
    - _Requirements: 21.1, 21.2_

  - [x] 22.2 隐私保护功能
    - 实现防截屏保护
    - 实现敏感数据清理
    - 添加审计日志和安全删除
    - _Requirements: 21.5, 21.6, 21.7_

- [ ] 23. 插件系统基础架构
  - [ ] 23.1 插件管理器
    - 实现插件 API 和开发接口
    - 实现插件安装、启用、禁用管理
    - 添加插件沙箱安全执行环境
    - _Requirements: 26.1, 26.3, 26.4_

  - [ ] 23.2 插件数据和配置
    - 实现插件独立数据存储
    - 实现插件配置管理界面
    - 添加插件市场支持 (预留)
    - _Requirements: 26.2, 26.5_

- [x] 24. 最终集成和测试
- [x] 24. 最终集成和测试
  - [x] 24.1 端到端测试
    - 实现完整的用户流程测试
    - 测试所有功能的集成工作
    - 验证性能和稳定性
    - _Requirements: All_

  - [ ]* 24.2 全面属性测试验证
    - 运行所有属性测试确保通过
    - 验证测试覆盖率达到要求
    - 修复任何发现的问题

  - [x] 24.3 应用打包和分发
    - 配置 Electron 应用打包
    - 创建安装程序和自动更新
    - 准备应用商店发布材料
    - _Requirements: 31.8_

- [x] 25. 最终检查点 - 完整应用验证
  - 确保所有功能完整实现并正常工作
  - 验证应用性能和用户体验
  - 确认所有测试通过
  - 准备发布版本

## Notes

- 标记 `*` 的任务为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证和用户反馈
- 属性测试验证核心正确性属性
- 单元测试验证具体示例和边界情况
- 集成测试验证端到端用户流程